#!/usr/bin/env bash

set -euo pipefail

if [[ "${SKIP_GITLEAKS:-0}" == "1" ]]; then
  exit 0
fi

if ! command -v gitleaks >/dev/null 2>&1; then
  printf '%s\n' "pre-commit: gitleaks is required but not installed." >&2
  printf '%s\n' "Install gitleaks or set SKIP_GITLEAKS=1 for this commit." >&2
  exit 1
fi

if git diff --cached --quiet --exit-code; then
  exit 0
fi

printf '%s\n' "pre-commit: scanning staged changes with gitleaks..."

if ! gitleaks protect --staged --redact --no-banner; then
  printf '%s\n' "pre-commit: gitleaks detected potential secrets. Commit blocked." >&2
  exit 1
fi

exit 0
